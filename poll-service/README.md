# ğŸ—³ï¸ Poll Service

A standalone microservice responsible for managing polls in the **alx-project-nexus** microservices ecosystem. This service handles poll creation, updates, scheduling, option management, and lifecycle transitions. It exposes a clean FastAPI-based REST API and integrates with an event-driven system for inter-service communication.

---

## ğŸ“˜ Overview

The **Poll Service** is responsible for **authoring and managing polls**, not counting votes or computing results. It acts as the authoritative source for poll metadata and settings.

### Core Responsibilities

* Create polls
* Add/edit poll options
* Manage poll status (draft â†’ active â†’ closed)
* Poll scheduling (start/end times)
* Validate poll configuration
* Publish poll-related events
* Serve poll metadata to other services

It does **not** handle:

* Vote submission â†’ handled by `vote-service`
* Result aggregation â†’ handled by `results-service`
* Authentication â†’ handled by `auth-service`

---

## ğŸ› Architecture

The Poll Service follows a clean architecture broken into:

### **1. API Layer**

* FastAPI routers (`/polls`)
* Request/response validation via Pydantic schemas

### **2. Domain / Services Layer**

* PollService class encapsulating business logic
* Validation (e.g., poll end_time > start_time)

### **3. Data Layer**

* SQLModel models for Poll and PollOption
* PostgreSQL for relational storage
* Database session handling

### **4. Events Layer (Optional)**

* Event producers to publish domain events:

  * `Poll.Created`
  * `Poll.Updated`
  * `Poll.Started`
  * `Poll.Closed`

---

## ğŸ“‚ Project Structure

```
poll-service/
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ database.py
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ poll.py
â”‚   â”‚   â””â”€â”€ option.py
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ poll.py
â”‚   â”‚   â””â”€â”€ option.py
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â””â”€â”€ polls.py
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ poll_service.py
â”‚   â”œâ”€â”€ events/
â”‚   â”‚   â”œâ”€â”€ producer.py
â”‚   â”‚   â””â”€â”€ contracts.py
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ time.py
â”‚
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_polls.py
â”‚
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

---

## ğŸ—ƒ Database Schema

### Poll Table

| Column            | Type      | Description                   |
| ----------------- | --------- | ----------------------------- |
| poll_id           | UUID      | Primary Key                   |
| title             | TEXT      | Poll title                    |
| description       | TEXT      | Poll description              |
| author_id         | UUID      | Owner of the poll             |
| type              | ENUM      | single/multiple/ranked        |
| start_time        | TIMESTAMP | When the poll becomes active  |
| end_time          | TIMESTAMP | When the poll closes          |
| status            | ENUM      | draft/scheduled/active/closed |
| allow_anonymous   | BOOL      | Poll allows anon voters       |
| allow_change_vote | BOOL      | User can change vote          |
| max_choices       | INT       | For multi-choice polls        |
| created_at        | TIMESTAMP | Autogenerated                 |
| updated_at        | TIMESTAMP | Autogenerated                 |

### PollOption Table

| Column     | Type      | Description         |
| ---------- | --------- | ------------------- |
| option_id  | UUID      | Primary Key         |
| poll_id    | UUID      | Foreign key to poll |
| text       | TEXT      | Option label        |
| order      | INT       | Display order       |
| created_at | TIMESTAMP | Autogenerated       |

---

## ğŸš€ API Endpoints

Root path: `/polls`

### Create Poll

`POST /polls/`

```json
{
  "title": "Best Programming Language?",
  "description": "Pick one",
  "type": "single",
  "options": ["Python", "Rust", "Go"],
  "start_time": "2025-10-10T12:00:00",
  "end_time": "2025-10-11T12:00:00",
  "allow_anonymous": true,
  "allow_change_vote": false
}
```

### Get Poll

`GET /polls/{poll_id}`

### List Polls

`GET /polls?author_id={uuid}&status=active`

### Update Poll

`PATCH /polls/{poll_id}`

### Add Poll Option

`POST /polls/{poll_id}/options`

### Change Poll Status

`POST /polls/{poll_id}/status`

```json
{ "status": "active" }
```

---

## ğŸ“¡ Events Emitted

All poll lifecycle changes trigger events. Example structure:

```json
{
  "event_type": "Poll.Created",
  "event_id": "uuid",
  "timestamp": "ISO8601",
  "payload": {
    "poll_id": "uuid",
    "title": "string",
    "author_id": "uuid"
  }
}
```

### Event Types

* `Poll.Created`
* `Poll.Updated`
* `Poll.Started`
* `Poll.Closed`

These events are consumed by:

* vote-service
* results-service
* notification-service
* analytics service

---

## ğŸ“¡ Event Publishing

The Poll Service publishes domain events to RabbitMQ for inter-service communication:

### Published Events

#### 1. `poll.created`
Published when a new poll is created.

```json
{
  "event_type": "poll.created",
  "timestamp": "2025-11-21T10:30:00Z",
  "poll_id": "uuid",
  "title": "Best Programming Language?",
  "description": "Vote for your favorite",
  "author_id": "user-uuid",
  "type": "single",
  "status": "draft",
  "allow_anonymous": true,
  "allow_change_vote": false,
  "max_choices": null,
  "options": [
    {"id": "opt-1", "text": "Python", "order": 0},
    {"id": "opt-2", "text": "JavaScript", "order": 1}
  ]
}
```

#### 2. `poll.updated`
Published when poll metadata is updated.

```json
{
  "event_type": "poll.updated",
  "timestamp": "2025-11-21T10:35:00Z",
  "poll_id": "uuid",
  "title": "Best Programming Language?",
  "author_id": "user-uuid",
  "type": "single",
  "status": "active",
  "description": "Updated description",
  "updated_fields": ["description", "status"]
}
```

#### 3. `poll.started`
Published when a poll status changes to `active`.

```json
{
  "event_type": "poll.started",
  "timestamp": "2025-11-21T10:40:00Z",
  "poll_id": "uuid",
  "title": "Best Programming Language?",
  "author_id": "user-uuid",
  "type": "single",
  "status": "active",
  "start_time": "2025-11-21T10:40:00Z"
}
```

#### 4. `poll.closed`
Published when a poll status changes to `closed`.

```json
{
  "event_type": "poll.closed",
  "timestamp": "2025-11-22T10:40:00Z",
  "poll_id": "uuid",
  "title": "Best Programming Language?",
  "author_id": "user-uuid",
  "type": "single",
  "status": "closed",
  "end_time": "2025-11-22T10:40:00Z",
  "total_options": 4
}
```

### Event Configuration

Events are published to a RabbitMQ topic exchange (`poll_events`) with routing keys:
- `poll.created`
- `poll.updated`
- `poll.started`
- `poll.closed`

Consumer services can subscribe using topic patterns like `poll.*` or `poll.created`.

---

## âš™ï¸ Configuration

Environment variables:

```bash
# Database
DATABASE_URL=sqlite:///./polls.db
# For PostgreSQL: postgresql://user:password@localhost:5432/polls_db

# RabbitMQ
RABBITMQ_HOST=localhost
RABBITMQ_PORT=5672
RABBITMQ_USER=guest
RABBITMQ_PASSWORD=guest
RABBITMQ_VHOST=/

# Service
SERVICE_PORT=8000
LOG_LEVEL=INFO
```

Copy `.env.example` to `.env` and adjust values:

```bash
cp .env.example .env
```

---

## ğŸš€ Running the Service

### Prerequisites

- Python 3.12+
- RabbitMQ server running (for event publishing)
- PostgreSQL or SQLite

### Local Development

1. **Create virtual environment:**
```bash
python3 -m venv env
source env/bin/activate  # On Windows: env\Scripts\activate
```

2. **Install dependencies:**
```bash
pip install -r requirements.txt
```

3. **Set up environment:**
```bash
cp .env.example .env
# Edit .env with your configuration
```

4. **Run database migrations:**
```bash
alembic upgrade head
```

5. **Start the service:**
```bash
uvicorn main:app --reload --port 8000
```

API available at `http://localhost:8000`

API docs at `http://localhost:8000/docs`

---

## ğŸ“¦ Dependencies

- **FastAPI** - Modern web framework
- **SQLAlchemy** - ORM for database operations
- **Alembic** - Database migrations
- **Pika** - RabbitMQ client for Python
- **Pydantic** - Data validation and settings
- **Uvicorn** - ASGI server

---

## ğŸ³ Docker Support

### Build Image

```bash
docker build -t poll-service .
```

### Run Service

```bash
docker run -p 8001:8001 poll-service
```

---

## ğŸ§ª Testing

Run all tests:

```bash
pytest -q
```

---

## Roadmap

* Add poll categories/tags
* Add password-protected polls
* Add image upload for poll options
* Add admin moderation flows
* Improve scheduling with async workers
* Add caching for popular polls

---

## Contribution Guidelines

* Follow the repo coding style
* Use feature branches
* Write tests for new features
* Open a PR with description and screenshots

---

## Support

For questions or issues open a GitHub issue in the main repository.
